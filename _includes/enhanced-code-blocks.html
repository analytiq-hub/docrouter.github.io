<!-- Enhanced Code Blocks with Language Display and Interactive Buttons -->
<style>
  .code-block-container {
    position: relative;
    margin: 1.5rem 0;
    border-radius: 0.5rem;
    overflow: hidden;
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  }
  
  .code-block-header {
    position: absolute;
    top: 0;
    right: 0;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    background-color: transparent;
    padding: 0.5rem 1rem;
    border-bottom: none;
    z-index: 10;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
  }
  
  .code-block-container:hover .code-block-header {
    opacity: 1;
  }
  
  .code-block-buttons {
    display: flex;
    gap: 0.25rem;
    pointer-events: auto;
  }
  
  .code-block-btn {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(209, 213, 219, 0.5);
    color: #6b7280;
    padding: 0.25rem;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    backdrop-filter: blur(4px);
  }
  
  .code-block-btn:hover {
    background-color: rgba(255, 255, 255, 1);
    color: #374151;
    border-color: #9ca3af;
    transform: scale(1.05);
  }
  
  .code-block-btn.active {
    background-color: #3b82f6;
    border-color: #3b82f6;
    color: white;
  }
  
  .code-block-content {
    position: relative;
  }
  
  .code-block-content pre {
    margin: 0;
    border-radius: 0;
    overflow-x: auto;
  }
  
  
  
  .code-block-content.no-wrap pre {
    overflow-x: hidden;
    white-space: pre-wrap;
    word-break: break-all;
  }
  
  .code-copy-notification {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background-color: #10b981;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }
  
  .code-copy-notification.show {
    opacity: 1;
  }
  
  /* Override prose pre styles when in enhanced container */
  .code-block-container .prose pre {
    background-color: transparent;
    padding: 1rem;
    margin: 0;
  }

  /* Ultra-aggressive overrides to prevent any dark background flash */
  .code-block-container .hljs,
  .code-block-container pre,
  .code-block-container pre code,
  .code-block-container code {
    background: #ffffff !important;
    background-color: #ffffff !important;
    color: #333333 !important;
  }

  /* Override any dark theme styles immediately */
  .code-block-container pre code {
    background: transparent !important;
    color: inherit !important;
  }

  /* Prevent flash by setting initial styles on all potential elements */
  pre[class*="language-"],
  code[class*="language-"],
  .hljs,
  pre,
  code {
    background: #ffffff !important;
    background-color: #ffffff !important;
    color: #333333 !important;
  }

  /* Keywords (def, class, if, etc.) - Purple */
  .code-block-container .hljs-keyword,
  .code-block-container .hljs-selector-tag,
  .code-block-container .hljs-built_in {
    color: #9333ea !important;
  }

  /* Function names - Blue */
  .code-block-container .hljs-name,
  .code-block-container .hljs-title.function_ {
    color: #2563eb !important;
  }

  /* Strings - Orange/Green */
  .code-block-container .hljs-string,
  .code-block-container .hljs-attr {
    color: #ea580c !important;
  }

  /* Comments - Light gray */
  .code-block-container .hljs-comment,
  .code-block-container .hljs-quote {
    color: #6b7280 !important;
    font-style: italic;
  }

  /* Numbers - Blue */
  .code-block-container .hljs-number,
  .code-block-container .hljs-literal {
    color: #2563eb !important;
  }

  /* Types and classes - Orange */
  .code-block-container .hljs-type,
  .code-block-container .hljs-class,
  .code-block-container .hljs-title.class_ {
    color: #ea580c !important;
  }

  /* Variables and properties - Dark gray */
  .code-block-container .hljs-variable,
  .code-block-container .hljs-property {
    color: #374151 !important;
  }

  /* JSON specific colors - match GPT style more closely */
  .code-block-container .hljs-attr {
    color: #9333ea !important;
  }

  .code-block-container .hljs-string {
    color: #ea580c !important;
  }

  .code-block-container .hljs-literal {
    color: #2563eb !important;
  }

  /* Additional overrides to ensure light theme */
  .code-block-container .hljs-doctag,
  .code-block-container .hljs-meta,
  .code-block-container .hljs-meta-keyword,
  .code-block-container .hljs-meta-string {
    color: #ea580c !important;
  }

  /* Ensure all text elements use our color scheme */
  .code-block-container .hljs * {
    background: transparent !important;
  }

  /* Force override highlight.js theme completely - prevent flash */
  .code-block-container pre[class*="language-"],
  .code-block-container code[class*="language-"],
  .code-block-container .hljs,
  .code-block-container .hljs-subst,
  .code-block-container .hljs-tag,
  .code-block-container .hljs-title,
  pre[class*="language-"],
  code[class*="language-"],
  .hljs {
    background: #ffffff !important;
    color: #333333 !important;
  }
  
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Process all code blocks after highlight.js has run
  setTimeout(enhanceCodeBlocks, 100);
});

function enhanceCodeBlocks() {
  const codeBlocks = document.querySelectorAll('pre code[class*="language-"]');
  
  codeBlocks.forEach(function(codeElement) {
    const preElement = codeElement.parentNode;
    
    // Skip if already enhanced
    if (preElement.closest('.code-block-container')) return;
    
    // Create enhanced container
    const container = document.createElement('div');
    container.className = 'code-block-container';

    // Create header
    const header = document.createElement('div');
    header.className = 'code-block-header';
    
    // Button container
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'code-block-buttons';
    
    // Word wrap button
    const wrapBtn = document.createElement('button');
    wrapBtn.className = 'code-block-btn';
    wrapBtn.innerHTML = `
      <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M3 4h10M3 12h10M3 8h6l-2-2M7 8l-2 2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
    
    // Copy button
    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-block-btn';
    copyBtn.innerHTML = `
      <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="4" y="4" width="8" height="8" rx="1"/>
        <path d="M2 8V4a2 2 0 012-2h4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
    
    // Assemble header
    buttonsContainer.appendChild(wrapBtn);
    buttonsContainer.appendChild(copyBtn);
    header.appendChild(buttonsContainer);
    
    // Create content container
    const contentContainer = document.createElement('div');
    contentContainer.className = 'code-block-content';
    
    // Copy notification
    const notification = document.createElement('div');
    notification.className = 'code-copy-notification';
    notification.textContent = 'Copied!';
    contentContainer.appendChild(notification);
    
    // Move pre element into content container
    preElement.parentNode.insertBefore(container, preElement);
    contentContainer.appendChild(preElement);
    
    // Assemble enhanced container
    container.appendChild(header);
    container.appendChild(contentContainer);
    
    // Add event listeners
    let isWrapped = false;
    
    wrapBtn.addEventListener('click', function() {
      isWrapped = !isWrapped;
      if (isWrapped) {
        contentContainer.classList.add('no-wrap');
        wrapBtn.innerHTML = `
          <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M3 4h10M3 12h10M3 8h10" stroke-linecap="round"/>
          </svg>
        `;
        wrapBtn.classList.add('active');
      } else {
        contentContainer.classList.remove('no-wrap');
        wrapBtn.innerHTML = `
          <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M3 4h10M3 12h10M3 8h6l-2-2M7 8l-2 2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;
        wrapBtn.classList.remove('active');
      }
    });
    
    copyBtn.addEventListener('click', function() {
      const code = codeElement.textContent;
      const originalIcon = copyBtn.innerHTML;
      
      // Show checkmark
      copyBtn.innerHTML = `
        <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M3 8l4 4 6-8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
      
      navigator.clipboard.writeText(code).then(function() {
        notification.classList.add('show');
        setTimeout(function() {
          notification.classList.remove('show');
          copyBtn.innerHTML = originalIcon;
        }, 2000);
      }).catch(function() {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = code;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        notification.classList.add('show');
        setTimeout(function() {
          notification.classList.remove('show');
          copyBtn.innerHTML = originalIcon;
        }, 2000);
      });
    });
  });
}
</script>