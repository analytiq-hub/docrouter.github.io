<!-- Enhanced Code Blocks with Language Display and Interactive Buttons -->
<style>
  .code-block-container {
    position: relative;
    margin: 1.5rem 0;
    border-radius: 0.5rem;
    overflow: hidden;
    background-color: rgb(31 41 55);
    border: 1px solid rgb(55 65 81);
  }
  
  .code-block-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: rgb(17 24 39);
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgb(55 65 81);
  }
  
  .code-block-language {
    font-size: 0.875rem;
    font-weight: 500;
    color: rgb(156 163 175);
    font-family: 'JetBrains Mono', ui-monospace, monospace;
    text-transform: lowercase;
    letter-spacing: 0.025em;
  }
  
  .code-block-buttons {
    display: flex;
    gap: 0.5rem;
  }
  
  .code-block-btn {
    background: none;
    border: 1px solid rgb(75 85 99);
    color: rgb(156 163 175);
    padding: 0.5rem;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
  }
  
  .code-block-btn:hover {
    background-color: rgb(55 65 81);
    color: rgb(229 231 235);
    border-color: rgb(107 114 128);
  }
  
  .code-block-btn.active {
    background-color: rgb(59 130 246);
    border-color: rgb(59 130 246);
    color: white;
  }
  
  .code-block-content {
    position: relative;
  }
  
  .code-block-content pre {
    margin: 0;
    border-radius: 0;
    overflow-x: auto;
  }
  
  .code-block-container .code-block-content.collapsed {
    position: relative !important;
    max-height: 60px !important;
    overflow: hidden !important;
  }
  
  .code-block-content.collapsed::after {
    content: attr(data-hidden-lines);
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(rgba(31, 41, 55, 0.8), rgb(31, 41, 55));
    color: rgb(156, 163, 175);
    text-align: center;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-family: 'JetBrains Mono', ui-monospace, monospace;
    z-index: 10;
    height: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  
  .code-block-content.no-wrap pre {
    overflow-x: hidden;
    white-space: pre-wrap;
    word-break: break-all;
  }
  
  .code-copy-notification {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background-color: rgb(34 197 94);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }
  
  .code-copy-notification.show {
    opacity: 1;
  }
  
  /* Override prose pre styles when in enhanced container */
  .code-block-container .prose pre {
    background-color: transparent;
    padding: 1rem;
    margin: 0;
  }
  
  /* Ensure collapsed state works even with prose styles */
  .prose .code-block-content.collapsed,
  .prose .code-block-container .code-block-content.collapsed,
  .code-block-container .prose .code-block-content.collapsed {
    max-height: 60px !important;
    overflow: hidden !important;
    position: relative !important;
  }
  
  /* Also ensure the pre element within doesn't override */
  .code-block-container .code-block-content.collapsed pre {
    max-height: none !important;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Process all code blocks after highlight.js has run
  setTimeout(enhanceCodeBlocks, 100);
});

function enhanceCodeBlocks() {
  const codeBlocks = document.querySelectorAll('pre code[class*="language-"]');
  
  codeBlocks.forEach(function(codeElement) {
    const preElement = codeElement.parentNode;
    
    // Skip if already enhanced
    if (preElement.closest('.code-block-container')) return;
    
    // Extract language from class
    const languageClass = Array.from(codeElement.classList).find(cls => cls.startsWith('language-'));
    const language = languageClass ? languageClass.replace('language-', '') : 'text';
    
    // Create enhanced container
    const container = document.createElement('div');
    container.className = 'code-block-container';
    
    // Create header
    const header = document.createElement('div');
    header.className = 'code-block-header';
    
    // Language label
    const languageLabel = document.createElement('span');
    languageLabel.className = 'code-block-language';
    languageLabel.textContent = language.toLowerCase();
    
    // Button container
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'code-block-buttons';
    
    // Collapse/Expand button (starts expanded, shows collapse icon)
    const collapseBtn = document.createElement('button');
    collapseBtn.className = 'code-block-btn';
    collapseBtn.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 6l4 4 4-4"/>
      </svg>
    `;
    
    // Word wrap button
    const wrapBtn = document.createElement('button');
    wrapBtn.className = 'code-block-btn';
    wrapBtn.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M3 4h10M3 12h10M3 8h6l-2-2M7 8l-2 2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
    
    // Copy button
    const copyBtn = document.createElement('button');
    copyBtn.className = 'code-block-btn';
    copyBtn.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="4" y="4" width="8" height="8" rx="1"/>
        <path d="M2 8V4a2 2 0 012-2h4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
    
    // Assemble header
    header.appendChild(languageLabel);
    buttonsContainer.appendChild(collapseBtn);
    buttonsContainer.appendChild(wrapBtn);
    buttonsContainer.appendChild(copyBtn);
    header.appendChild(buttonsContainer);
    
    // Create content container
    const contentContainer = document.createElement('div');
    contentContainer.className = 'code-block-content';
    
    // Copy notification
    const notification = document.createElement('div');
    notification.className = 'code-copy-notification';
    notification.textContent = 'Copied!';
    contentContainer.appendChild(notification);
    
    // Move pre element into content container
    preElement.parentNode.insertBefore(container, preElement);
    contentContainer.appendChild(preElement);
    
    // Assemble enhanced container
    container.appendChild(header);
    container.appendChild(contentContainer);
    
    // Add event listeners
    let isCollapsed = false;
    let isWrapped = false;
    
    collapseBtn.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('Collapse button clicked, current state:', isCollapsed);
      
      isCollapsed = !isCollapsed;
      
      if (isCollapsed) {
        console.log('Collapsing...');
        // Calculate hidden lines
        const totalLines = codeElement.textContent.split('\n').length;
        const visibleLines = Math.floor(60 / 20); // Approximate lines visible in 60px (about 3 lines)
        const hiddenLines = Math.max(0, totalLines - visibleLines);
        
        contentContainer.classList.add('collapsed');
        contentContainer.setAttribute('data-hidden-lines', `${hiddenLines} hidden lines`);
        // Show expand icon (upward chevron) when collapsed
        collapseBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 10l-4-4-4 4"/>
          </svg>
        `;
        collapseBtn.classList.add('active');
        console.log('Collapsed - added class:', contentContainer.classList.contains('collapsed'));
      } else {
        console.log('Expanding...');
        contentContainer.classList.remove('collapsed');
        contentContainer.removeAttribute('data-hidden-lines');
        // Show collapse icon (downward chevron) when expanded
        collapseBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 6l4 4 4-4"/>
          </svg>
        `;
        collapseBtn.classList.remove('active');
        console.log('Expanded - removed class:', !contentContainer.classList.contains('collapsed'));
      }
    });
    
    wrapBtn.addEventListener('click', function() {
      isWrapped = !isWrapped;
      if (isWrapped) {
        contentContainer.classList.add('no-wrap');
        wrapBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M3 4h10M3 12h10M3 8h10" stroke-linecap="round"/>
          </svg>
        `;
        wrapBtn.classList.add('active');
      } else {
        contentContainer.classList.remove('no-wrap');
        wrapBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M3 4h10M3 12h10M3 8h6l-2-2M7 8l-2 2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;
        wrapBtn.classList.remove('active');
      }
    });
    
    copyBtn.addEventListener('click', function() {
      const code = codeElement.textContent;
      const originalIcon = copyBtn.innerHTML;
      
      // Show checkmark
      copyBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M3 8l4 4 6-8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
      
      navigator.clipboard.writeText(code).then(function() {
        notification.classList.add('show');
        setTimeout(function() {
          notification.classList.remove('show');
          copyBtn.innerHTML = originalIcon;
        }, 2000);
      }).catch(function() {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = code;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        notification.classList.add('show');
        setTimeout(function() {
          notification.classList.remove('show');
          copyBtn.innerHTML = originalIcon;
        }, 2000);
      });
    });
  });
}
</script>